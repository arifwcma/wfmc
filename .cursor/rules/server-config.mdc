---
description: Production server infrastructure and configuration details
alwaysApply: true
---

# Production Server (EC2)

## Instance Details

| Property | Value |
|---|---|
| Provider | AWS EC2 |
| Region | ap-southeast-2 (Sydney) |
| Instance type | t4g.large (ARM/Graviton, 2 vCPU, 8 GB RAM) |
| OS | Ubuntu 24.04.3 LTS (Noble) arm64 |
| Storage | 64 GB gp3 EBS |
| Public IP | 13.238.185.227 |
| SSH user | ubuntu |
| SSH key | ED25519, `C:\Users\m.rahman\assets\keys\GIS-Server.pem` |
| PPK (PuTTY) | `C:\Users\m.rahman\assets\keys\GIS-Server.ppk` |

## SSH Access

```powershell
ssh -i C:\Users\m.rahman\assets\keys\GIS-Server.pem ubuntu@13.238.185.227
```

SSH is restricted to office IP only via AWS Security Group.

## Security Measures

- **Auto security updates**: unattended-upgrades enabled
- **SSH hardened**: `PermitRootLogin no`, `PasswordAuthentication no` in `/etc/ssh/sshd_config`
- **UFW firewall**: only ports 22/tcp, 80/tcp, 443/tcp open
- **AWS Security Group**: SSH (22) restricted to office IP; HTTP (80) and HTTPS (443) public
- **Fail2Ban**: active, auto-blocks brute-force attempts
- **SSL**: Let's Encrypt via Certbot, auto-renewal enabled
- **Certificate covers**: wcma.work, testpozi.online
- **Cert path**: `/etc/letsencrypt/live/wcma.work/`

## Architecture

```
Internet
  │
  ├─ HTTPS (443) ──► Nginx (reverse proxy + SSL termination)
  │                    ├─ wcma.work        ──► localhost:3001 (Next.js mapnj2)
  │                    ├─ wimmera.xyz      ──► localhost:3002 (Next.js xyz tiles)
  │                    └─ testpozi.online  ──► Lizmap Web Client (PHP-FPM)
  │                                              └─ QGIS requests ──► Py-QGIS-Server (localhost:7200)
  │
  ├─ Py-QGIS-Server (7200, internal only)
  │    └─ QGIS Server workers + Lizmap server plugin
  │    └─ Projects root: /srv/data/
  │
  └─ Apache (8080, internal only, legacy — no active QGIS vhost)
```

## Domains & DNS (Route 53)

| Domain | Type | Points to | Service |
|---|---|---|---|
| wcma.work | A | 13.238.185.227 | Next.js mapnj2 (port 3001) |
| wimmera.xyz | A | 13.238.185.227 | Next.js xyz tile server (port 3002) |
| testpozi.online | A | 13.238.185.227 | Lizmap Web Client → Py-QGIS-Server (port 7200) |

## Services & Ports

| Port | Process | Manager | Config |
|---|---|---|---|
| 80 | Nginx | systemd | `/etc/nginx/sites-available/` |
| 443 | Nginx (SSL) | systemd | Certbot-managed |
| 3001 | Next.js (mapnj2) | PM2 | `~/mapnj2/` |
| 3002 | Next.js (xyz tiles) | PM2 | `~/xyz/` (assumed) |
| 7200 | Py-QGIS-Server | systemd (`qgis.service`) | `/srv/qgis/server.conf` |
| 8080 | Apache (legacy, no active QGIS vhost) | systemd | `/etc/apache2/` |

## Nginx Configs

- `/etc/nginx/sites-available/wcma.work` — reverse proxy to localhost:3001
- `/etc/nginx/sites-available/testpozi.online` — serves Lizmap PHP app + SSL
- `/etc/nginx/sites-available/wimmera.xyz` — reverse proxy to localhost:3002
- Default site is **disabled** (removed from sites-enabled)

## Py-QGIS-Server (QGIS Server)

- **Installed at**: `/opt/local/py-qgis-server/` (Python venv)
- **Config**: `/srv/qgis/server.conf`
- **Environment file**: `/srv/qgis/config/qgis-service.env`
- **Systemd service**: `/etc/systemd/system/qgis.service` (name: `qgis`)
- **Port**: 7200 (bound to 127.0.0.1)
- **Workers**: 2
- **Plugin path**: `/srv/qgis/plugins/`
- **Projects root**: `/srv/data/`
- **Restart monitor**: `/var/lib/py-qgis-server/py-qgis-restartmon`
- **Reload script**: `/usr/bin/qgis-reload`
- **Log**: `/var/log/qgis/qgis-server.log`
- **OWS endpoint**: `http://127.0.0.1:7200/ows/`
- **Lizmap API endpoint**: `http://127.0.0.1:7200/lizmap/`
- **QGIS version**: 3.34.4 (Prizren)
- **Lizmap server plugin**: 2.13.0

## Lizmap Web Client

- **Version**: 3.9.4
- **Path**: `/var/www/lizmap-web-client-3.9.4/`
- **Web root symlink**: `/var/www/html/lizmap` → `/var/www/lizmap-web-client-3.9.4/lizmap/www/`
- **Config dir**: `/var/www/lizmap-web-client-3.9.4/lizmap/var/config/`
- **Key config files**:
  - `lizmapConfig.ini.php` — wmsServerURL, lizmapPluginAPIURL, repositories
  - `localconfig.ini.php` — local overrides
  - `profiles.ini.php` — database profiles (SQLite by default)
- **WMS Server URL**: `http://127.0.0.1:7200/ows/`
- **Lizmap Plugin API URL**: `http://127.0.0.1:7200/lizmap/`
- **Root repositories**: `/srv/data`
- **Admin URL**: `https://testpozi.online/admin.php`
- **Default admin**: `admin` (password changed on first login)
- **PHP**: 8.3 via php8.3-fpm
- **Database**: SQLite (in `lizmap/var/db/`)

## QGIS Project (wfml)

- **Git repo**: `git@github.com:arifwcma/wfml.git`
- **Cloned to**: `/var/www/qgis/wfml/`
- **Symlinked into Py-QGIS-Server**: `/srv/data/wfml` → `/var/www/qgis/wfml`
- **Project file**: `wfml.qgs`
- **Lizmap config**: `wfml.qgs.cfg` (targets Lizmap 3.9, created with Lizmap plugin 4.5.7)
- **CRS**: EPSG:7854

## Next.js Apps

### mapnj2 (wcma.work)
- Path: `/home/ubuntu/mapnj2/`
- Git repo: `git@github.com:arifwcma/mapnj2.git`
- Port: 3001
- PM2 name: `mapnj2`
- Uses Google Earth Engine service account: `/home/ubuntu/mapnj2/sensitive_resources/service-account.json`
- GCP project: `gee-wcma-ndvi`
- Service account: `gee-service@gee-wcma-ndvi.iam.gserviceaccount.com`

### xyz tile server (wimmera.xyz)
- Path: `/home/ubuntu/xyz/` (assumed)
- Port: 3002
- PM2 name: (check with `pm2 list`)
- Serves XYZ raster tiles (e.g. NDVI)

## PM2

- Apps start on boot via `pm2 startup` + `pm2 save`
- Check status: `pm2 list`
- Logs: `pm2 logs <name>`
- Restart: `pm2 restart <name>`

## Node.js

- Installed via NodeSource (v22.x)
- PM2 installed globally

## Docker

- Installed but **not actively used** (was attempted for Lizmap but ARM64 incompatible)
- Can be removed if disk space needed: `sudo apt remove docker-ce docker-ce-cli containerd.io`

## Key Paths on Server

| Path | Description |
|---|---|
| `/home/ubuntu/mapnj2/` | mapnj2 Next.js app |
| `/home/ubuntu/xyz/` | xyz tile server (assumed) |
| `/var/www/qgis/wfml/` | QGIS project (wfml) |
| `/srv/data/wfml` | Symlink to wfml project (for Py-QGIS-Server) |
| `/srv/qgis/server.conf` | Py-QGIS-Server config |
| `/srv/qgis/plugins/` | QGIS Server plugins (Lizmap server plugin) |
| `/srv/qgis/config/qgis-service.env` | QGIS Server environment variables |
| `/opt/local/py-qgis-server/` | Py-QGIS-Server Python venv |
| `/var/www/lizmap-web-client-3.9.4/` | Lizmap Web Client |
| `/etc/nginx/sites-available/` | Nginx vhost configs |
| `/etc/apache2/` | Apache (legacy, no active QGIS vhost) |
| `/etc/letsencrypt/live/wcma.work/` | SSL certificates |
| `/var/log/qgis/qgis-server.log` | QGIS Server log |
| `/etc/systemd/system/qgis.service` | Py-QGIS-Server systemd unit |

## Server Build Date

2026-02-09 — rebuilt from scratch after previous instance was compromised.
Previous instance terminated. All credentials rotated (AWS keys, Google service account, SSH keys).
